<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agro Farm</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* –û–±—â–∞—è —Å–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ */
        :root {
            --primary-green: #e8f5e9;
            --light-green: #f1f8e9;
            --milk-white: #fafafa;
            --accent-green: #81c784;
            --dark-green: #388e3c;
            --text-dark: #2e3438;
            --text-light: #5a6268;
            --border-color: #d1e7dd;
            --game-color: #9c27b0;
            --game-gradient: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
            --calendar-gradient: linear-gradient(135deg, #4caf50 0%, var(--dark-green) 100%);
        }

        body {
            background-color: var(--milk-white);
            color: var(--text-dark);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: margin-left 0.3s ease;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏ */
        .navbar {
            padding: 0.5rem 1rem;
            height: 75px;
            z-index: 1030;
            background: linear-gradient(135deg, var(--light-green) 0%, var(--primary-green) 100%) !important;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            border-bottom: 1px solid var(--border-color);
        }

        .navbar-brand {
            background: rgba(129, 199, 132, 0.15);
            padding: 8px 15px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .navbar-brand:hover {
            background: rgba(129, 199, 132, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .clock-time {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark-green);
        }

        .clock-date {
            font-size: 0.85rem;
            color: var(--text-light);
            margin-top: 2px;
        }

        /* –ö–∞–ª–µ–Ω–¥–∞—Ä—å */
        .calendar-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 10px;
            width: 350px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.15);
            border: 1px solid var(--border-color);
            z-index: 1050;
            display: none;
            overflow: hidden;
            animation: slideDown 0.3s ease-out;
        }

        @keyframes slideDown {
            from { 
                opacity: 0;
                transform: translateY(-10px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .calendar-dropdown.show {
            display: block;
        }

        .calendar-header {
            background: var(--calendar-gradient);
            color: white;
            padding: 15px;
            text-align: center;
            position: relative;
        }

        .calendar-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .calendar-nav button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .calendar-nav button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .calendar-current-date {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .calendar-time-display {
            font-size: 2.5rem;
            font-weight: 700;
            letter-spacing: 2px;
            margin: 10px 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .calendar-time-label {
            font-size: 0.9rem;
            opacity: 0.9;
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 5px;
        }

        .calendar-body {
            padding: 20px;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }

        .calendar-weekday {
            text-align: center;
            font-weight: 600;
            color: var(--dark-green);
            font-size: 0.9rem;
            padding: 5px;
        }

        .calendar-days {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            position: relative;
        }

        .calendar-day:hover {
            background: rgba(129, 199, 132, 0.1);
        }

        .calendar-day.today {
            background: var(--calendar-gradient);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(76, 175, 80, 0.4);
        }

        .calendar-day.other-month {
            color: #bbb;
        }

        .calendar-day.selected {
            background: linear-gradient(135deg, var(--accent-green) 0%, var(--dark-green) 100%);
            color: white;
        }

        .calendar-day.has-events::after {
            content: '';
            position: absolute;
            bottom: 5px;
            width: 4px;
            height: 4px;
            background: var(--accent-green);
            border-radius: 50%;
        }

        .calendar-footer {
            padding: 15px;
            background: var(--light-green);
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .calendar-events {
            max-height: 200px;
            overflow-y: auto;
            padding: 0 15px;
        }

        .calendar-event {
            padding: 8px 12px;
            margin: 5px 0;
            background: rgba(129, 199, 132, 0.1);
            border-radius: 8px;
            border-left: 3px solid var(--accent-green);
            font-size: 0.9rem;
        }

        .calendar-event-time {
            font-weight: 600;
            color: var(--dark-green);
            font-size: 0.8rem;
        }

        .city-badge {
            background: linear-gradient(135deg, var(--accent-green) 0%, var(--dark-green) 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 8px rgba(129, 199, 132, 0.3);
            margin-left: 15px;
        }

        /* –ö–Ω–æ–ø–∫–∞ –∏–≥—Ä—ã –≤ –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏ */
        .game-button {
            background: var(--game-gradient);
            border: none;
            color: white;
            padding: 8px 20px;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(156, 39, 176, 0.4);
            display: flex;
            align-items: center;
            gap: 8px;
            margin-right: 15px;
            position: relative;
            overflow: hidden;
        }

        .game-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(156, 39, 176, 0.6);
        }

        .game-button:active {
            transform: translateY(-1px);
        }

        .game-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }

        .game-button:hover::before {
            left: 100%;
        }

        .game-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.7; }
            50% { opacity: 1; }
            100% { opacity: 0.7; }
        }

        .search-container {
            position: relative;
            max-width: 450px;
            margin: 0 20px;
        }

        .search-container .input-group {
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .search-container .form-control {
            background: white;
            border: 2px solid var(--border-color);
            padding: 10px 15px;
            font-size: 0.95rem;
            color: var(--text-dark);
            transition: all 0.3s ease;
        }

        .search-container .form-control:focus {
            background: white;
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px rgba(129, 199, 132, 0.15);
        }

        .search-container .btn-primary {
            background: linear-gradient(135deg, var(--accent-green) 0%, var(--dark-green) 100%);
            border: none;
            color: white;
            padding: 10px 20px;
            transition: all 0.3s ease;
        }

        .search-container .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(129, 199, 132, 0.4);
        }

        .search-results {
            max-height: 400px;
            overflow-y: auto;
            position: absolute;
            width: 100%;
            z-index: 1000;
            display: none;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border: 1px solid var(--border-color);
            background: white;
            margin-top: 5px;
        }

        .search-results .list-group-item {
            border: none;
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            transition: all 0.2s ease;
            color: var(--text-dark);
        }

        .search-results .list-group-item:hover {
            background: linear-gradient(135deg, var(--light-green) 0%, #e8f5e9 100%);
            transform: translateX(5px);
        }

        .user-dropdown .dropdown-toggle {
            background: rgba(129, 199, 132, 0.15);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 8px 15px;
            transition: all 0.3s ease;
        }

        .user-dropdown .dropdown-toggle:hover {
            background: rgba(129, 199, 132, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .user-name {
            font-weight: 600;
            color: var(--dark-green);
        }

        .user-role {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .dropdown-menu {
            border-radius: 12px;
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            padding: 10px;
            min-width: 220px;
            background: white;
        }

        .dropdown-item {
            border-radius: 8px;
            padding: 10px 15px;
            margin: 3px 0;
            transition: all 0.2s ease;
            color: var(--text-dark);
        }

        .dropdown-item:hover {
            background: linear-gradient(135deg, var(--accent-green) 0%, var(--dark-green) 100%);
            color: white;
            transform: translateX(5px);
        }

        .dropdown-item-danger:hover {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        }

        /* –ö–Ω–æ–ø–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª—å—é */
        .sidebar-control {
            background: rgba(129, 199, 132, 0.15);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            transition: all 0.3s ease;
            color: var(--dark-green);
            margin-right: 10px;
        }

        .sidebar-control:hover {
            background: rgba(129, 199, 132, 0.25);
            transform: translateY(-2px);
        }

        /* –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å */
        .sidebar {
            background: linear-gradient(180deg, white 0%, var(--light-green) 100%);
            min-height: 100vh;
            padding: 20px;
            box-shadow: 2px 0 15px rgba(0, 0, 0, 0.05);
            border-right: 1px solid var(--border-color);
            position: fixed;
            left: 0;
            top: 75px;
            width: 250px;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 1020;
        }

        .sidebar.show {
            transform: translateX(0);
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar-content {
            height: calc(100vh - 95px);
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .sidebar a {
            color: var(--text-dark);
            text-decoration: none;
            padding: 12px 15px;
            display: block;
            border-radius: 10px;
            margin-bottom: 5px;
            transition: all 0.3s ease;
            background: rgba(129, 199, 132, 0.08);
            border: 1px solid rgba(129, 199, 132, 0.2);
        }
        
        .sidebar a:hover {
            background: rgba(129, 199, 132, 0.2);
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(129, 199, 132, 0.2);
        }
        
        .sidebar a.active {
            background: linear-gradient(135deg, var(--accent-green) 0%, var(--dark-green) 100%);
            border-color: rgba(255, 255, 255, 0.3);
            color: white;
            box-shadow: 0 5px 15px rgba(129, 199, 132, 0.3);
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        .main-content {
            padding-top: 75px;
            transition: margin-left 0.3s ease;
        }

        .main-content.sidebar-open {
            margin-left: 250px;
        }

        .main-content.sidebar-closed {
            margin-left: 0;
        }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .stat-card {
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            color: white;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.12);
        }
        
        .bg-primary { 
            background: linear-gradient(135deg, var(--accent-green) 0%, var(--dark-green) 100%);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .bg-success { 
            background: linear-gradient(135deg, #4caf50 0%, var(--dark-green) 100%);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .bg-warning { 
            background: linear-gradient(135deg, #ffb74d 0%, #f57c00 100%);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .bg-info { 
            background: linear-gradient(135deg, #4dd0e1 0%, #0097a7 100%);
            border-color: rgba(255, 255, 255, 0.2);
        }
        
        .bg-danger { 
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —á–∞—Ç */
        .simple-chat-widget {
            position: fixed;
            bottom: 25px;
            right: 25px;
            z-index: 1000;
        }
        
        .chat-icon {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, var(--accent-green) 0%, var(--dark-green) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
            cursor: pointer;
            box-shadow: 0 6px 20px rgba(129, 199, 132, 0.4);
            transition: all 0.3s ease;
            border: 3px solid white;
        }
        
        .chat-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(129, 199, 132, 0.6);
        }
        
        .chat-notification {
            position: absolute;
            top: -5px;
            right: -5px;
            background: linear-gradient(135deg, #ff5722 0%, #d84315 100%);
            color: white;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid white;
            box-shadow: 0 3px 10px rgba(255, 87, 34, 0.4);
        }
        
        .chat-window {
            position: absolute;
            bottom: 85px;
            right: 0;
            width: 450px;
            height: 600px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.2);
            display: none;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .chat-window.show {
            display: flex;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(10px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .chat-header {
            background: linear-gradient(135deg, var(--light-green) 0%, var(--primary-green) 100%);
            color: var(--text-dark);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
        
        .chat-title {
            font-size: 16px;
            font-weight: 600;
            margin: 0;
            color: var(--dark-green);
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fdfdfd;
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 400px;
        }
        
        .message {
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 85%;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
            background: white;
        }
        
        .message.own {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-color: var(--accent-green);
            align-self: flex-end;
        }
        
        .message.other {
            background: white;
            align-self: flex-start;
        }
        
        .message-sender {
            font-weight: 600;
            color: var(--dark-green);
            font-size: 14px;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .sender-role {
            font-size: 11px;
            background: #757575;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 500;
        }
        
        .message.own .sender-role {
            background: linear-gradient(135deg, var(--accent-green) 0%, var(--dark-green) 100%);
        }
        
        .message-text {
            color: var(--text-dark);
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 5px;
            word-break: break-word;
        }
        
        .message-time {
            font-size: 11px;
            color: #757575;
            text-align: right;
        }
        
        .chat-input-area {
            padding: 15px;
            background: white;
            border-top: 1px solid var(--border-color);
        }
        
        .chat-input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s ease;
            background: white;
            color: var(--text-dark);
        }
        
        .chat-input:focus {
            border-color: var(--accent-green);
            box-shadow: 0 0 0 3px rgba(129, 199, 132, 0.15);
        }
        
        .send-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, var(--accent-green) 0%, var(--dark-green) 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            min-width: 90px;
        }
        
        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(129, 199, 132, 0.4);
        }
        
        .send-btn:disabled {
            background: #bdbdbd;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .chat-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .chat-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            color: var(--text-light);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .chat-btn:hover {
            background: rgba(129, 199, 132, 0.1);
            color: var(--dark-green);
        }
        
        .requests-btn {
            background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(255, 152, 0, 0.3);
            white-space: nowrap;
            flex: 1;
            justify-content: center;
        }
        
        .requests-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4);
            background: linear-gradient(135deg, #ff5722 0%, #e64a19 100%);
        }
        
        .requests-btn.active {
            background: linear-gradient(135deg, #ff5722 0%, #d84315 100%);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .requests-count-badge {
            background: white;
            color: #ff5722;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 700;
            min-width: 20px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .chat-select-wrapper {
            position: relative;
            flex: 1;
            margin: 0 10px;
        }
        
        .chat-select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: white;
            color: var(--text-dark);
            font-size: 14px;
            appearance: none;
            cursor: pointer;
        }
        
        .select-arrow {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
            pointer-events: none;
        }
        
        .chat-empty, .chat-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-light);
        }
        
        .message-status {
            font-size: 10px;
            color: #757575;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ */
        .chat-requests-section {
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
            border-radius: 12px;
            padding: 20px;
            margin: 15px;
            border: 3px solid #ff9800;
            box-shadow: 0 6px 20px rgba(255, 152, 0, 0.25);
            position: relative;
            overflow: hidden;
        }

        .chat-requests-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #ff9800, #ff5722, #ff9800);
            animation: shimmer 3s infinite linear;
        }

        @keyframes shimmer {
            0% { background-position: -200px 0; }
            100% { background-position: calc(200px + 100%) 0; }
        }

        .chat-requests-title {
            color: #e65100;
            font-weight: 700;
            font-size: 1.2rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .chat-requests-title i {
            font-size: 1.4rem;
            background: linear-gradient(135deg, #ff9800, #ff5722);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .chat-requests-title .badge {
            background: linear-gradient(135deg, #ff5722, #d84315);
            font-size: 0.9rem;
            padding: 6px 12px;
            border-radius: 20px;
            box-shadow: 0 3px 10px rgba(255, 87, 34, 0.4);
            animation: badge-pulse 2s infinite;
        }

        @keyframes badge-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* –ö–∞—Ä—Ç–æ—á–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ */
        .chat-request-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.08);
            border: 1px solid #e0e0e0;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .chat-request-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.12);
        }
        
        .chat-request-card.pending {
            border-left: 4px solid #ff9800;
            background: linear-gradient(135deg, #fff3e0 0%, #ffecb3 100%);
        }
        
        .chat-request-card.approved {
            border-left: 4px solid #4caf50;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        }
        
        .chat-request-card.rejected {
            border-left: 4px solid #f44336;
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
        }
        
        .chat-request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .chat-request-user {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chat-request-user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1rem;
        }
        
        .chat-request-user-info h6 {
            margin: 0;
            font-size: 0.95rem;
            color: #333;
        }
        
        .chat-request-user-info small {
            color: #666;
            font-size: 0.8rem;
        }
        
        .chat-request-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .chat-request-status.pending {
            background: rgba(255, 152, 0, 0.15);
            color: #ff6f00;
        }
        
        .chat-request-status.approved {
            background: rgba(76, 175, 80, 0.15);
            color: #388e3c;
        }
        
        .chat-request-status.rejected {
            background: rgba(244, 67, 54, 0.15);
            color: #d32f2f;
        }
        
        .chat-request-message {
            color: #333;
            font-size: 0.9rem;
            line-height: 1.5;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 6px;
            border-left: 3px solid #ff9800;
        }
        
        .chat-request-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }
        
        .chat-request-time {
            font-size: 0.8rem;
            color: #666;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .chat-request-actions {
            display: flex;
            gap: 8px;
        }
        
        .chat-request-actions .btn {
            padding: 6px 12px;
            font-size: 0.85rem;
            border-radius: 6px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .chat-request-actions .btn-approve {
            background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
            color: white;
            border: none;
        }
        
        .chat-request-actions .btn-reject {
            background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
            color: white;
            border: none;
        }
        
        .chat-request-actions .btn-delete {
            background: linear-gradient(135deg, #9e9e9e 0%, #616161 100%);
            color: white;
            border: none;
        }
        
        .chat-requests-empty {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .chat-requests-empty i {
            font-size: 3rem;
            margin-bottom: 15px;
            opacity: 0.3;
            color: #ff9800;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏ */
        .time-selection-area {
            padding: 15px;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border-top: 1px solid #bbdefb;
        }
        
        .time-selection-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.08);
            border: 1px solid #bbdefb;
        }
        
        .time-selection-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: #1976d2;
        }
        
        .time-selection-header i {
            font-size: 1.5rem;
        }
        
        .time-selection-header h6 {
            margin: 0;
            font-weight: 600;
        }
        
        .time-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .time-option {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            border: 2px solid #bbdefb;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .time-option:hover {
            background: linear-gradient(135deg, #bbdefb 0%, #90caf9 100%);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.3);
        }
        
        .time-duration {
            font-weight: 600;
            color: #1976d2;
            margin-bottom: 5px;
        }
        
        .time-icon {
            font-size: 1.5rem;
        }
        
        .custom-time-area {
            animation: fadeIn 0.3s ease-out;
        }
        
        .time-selection-buttons {
            text-align: center;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –∑–∞–ø—Ä–æ—Å–æ–≤ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è */
        .permission-request-area {
            padding: 15px;
            background: linear-gradient(135deg, #fff3e0 0%, #ffecb3 100%);
            border-top: 1px solid #ffcc80;
        }
        
        .permission-request-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.08);
            border: 1px solid #ffcc80;
        }
        
        .permission-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            color: #ff6f00;
        }
        
        .permission-header i {
            font-size: 1.5rem;
        }
        
        .permission-header h6 {
            margin: 0;
            font-weight: 600;
        }
        
        .permission-message {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .permission-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ffcc80;
            border-radius: 8px;
            font-size: 0.9rem;
            resize: none;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            background: #fff9c4;
        }
        
        .permission-textarea:focus {
            border-color: #ff9800;
            box-shadow: 0 0 0 3px rgba(255, 152, 0, 0.15);
            background: white;
            outline: none;
        }
        
        .permission-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .permission-status {
            font-size: 0.85rem;
            padding: 10px;
            border-radius: 8px;
            display: none;
            animation: fadeIn 0.3s ease-out;
        }
        
        .permission-status.success {
            background: rgba(76, 175, 80, 0.15);
            color: #388e3c;
            border: 1px solid rgba(76, 175, 80, 0.3);
        }
        
        .permission-status.error {
            background: rgba(244, 67, 54, 0.1);
            color: #d32f2f;
            border: 1px solid rgba(244, 67, 54, 0.2);
        }
        
        .permission-status.warning {
            background: rgba(255, 152, 0, 0.1);
            color: #f57c00;
            border: 1px solid rgba(255, 152, 0, 0.2);
        }
        
        /* –°—á–µ—Ç—á–∏–∫ –≤—Ä–µ–º–µ–Ω–∏ –≤ –∫–∞—Ä—Ç–æ—á–∫–µ –∑–∞–ø—Ä–æ—Å–∞ */
        .time-remaining {
            font-size: 0.8rem;
            color: #388e3c;
            background: rgba(76, 175, 80, 0.15);
            padding: 4px 8px;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            margin-top: 5px;
        }
        
        .time-remaining.expired {
            color: #d32f2f;
            background: rgba(244, 67, 54, 0.15);
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7); }
            70% { box-shadow: 0 0 0 15px rgba(255, 152, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0); }
        }
        
        .requests-glow {
            animation: pulse-glow 2s infinite;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–∑ —Ä–µ–∂–∏–º–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ */
        .back-to-chat-btn {
            background: linear-gradient(135deg, var(--accent-green) 0%, var(--dark-green) 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 10px rgba(129, 199, 132, 0.3);
            margin-right: auto;
        }
        
        .back-to-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(129, 199, 132, 0.4);
        }
        
        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }
        
        .chat-buttons-row {
            display: flex;
            gap: 10px;
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è —á–∞—Ç–∞ */
        @media (max-width: 768px) {
            .chat-window {
                width: calc(100vw - 40px);
                height: 70vh;
                right: 20px;
                bottom: 80px;
            }
            
            .requests-btn {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .requests-btn span {
                display: none;
            }
            
            .chat-select-wrapper {
                margin: 0 5px;
            }
            
            .chat-buttons-row {
                flex-direction: column;
            }
            
            .chat-buttons-row .requests-btn,
            .chat-buttons-row .send-btn {
                width: 100%;
            }
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 992px) {
            .search-container {
                max-width: 300px;
                margin: 0 10px;
            }
            
            .city-badge {
                margin-left: 10px;
                font-size: 0.8rem;
                padding: 4px 10px;
            }
            
            .clock-time {
                font-size: 1.1rem;
            }
            
            .game-button {
                padding: 6px 15px;
                font-size: 0.9rem;
            }
            
            .calendar-dropdown {
                width: 300px;
                left: 50%;
                transform: translateX(-50%);
            }
        }

        @media (max-width: 768px) {
            .navbar {
                height: 70px;
                padding: 0.5rem;
            }
            
            .search-container {
                max-width: 200px;
            }
            
            .city-badge {
                display: none;
            }
            
            .clock-time {
                font-size: 1rem;
            }
            
            .game-button {
                padding: 5px 12px;
                font-size: 0.85rem;
                margin-right: 5px;
            }
            
            .user-name {
                font-size: 0.9rem;
            }
            
            .chat-window {
                width: calc(100vw - 40px);
                height: 70vh;
                right: 20px;
                bottom: 80px;
            }
            
            .simple-chat-widget {
                bottom: 20px;
                right: 20px;
            }
            
            .chat-icon {
                width: 60px;
                height: 60px;
                font-size: 24px;
            }
            
            .sidebar {
                top: 70px;
            }
            
            .main-content {
                padding-top: 70px;
            }
            
            .calendar-dropdown {
                width: calc(100vw - 40px);
                left: 20px;
            }
        }

        /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Scrollbar —Å—Ç–∏–ª–∏–∑–∞—Ü–∏—è */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--accent-green) 0%, var(--dark-green) 100%);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--dark-green) 0%, #2e7d32 100%);
        }

        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        .alert {
            border: 1px solid var(--border-color);
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }

        /* –ö–Ω–æ–ø–∫–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–∞–Ω–µ–ª–∏ */
        .mobile-sidebar-toggle {
            position: fixed;
            bottom: 100px;
            left: 20px;
            z-index: 1010;
            background: var(--game-gradient);
            color: white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(156, 39, 176, 0.4);
            transition: all 0.3s ease;
            display: none;
        }

        .mobile-sidebar-toggle:hover {
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .mobile-sidebar-toggle {
                display: flex;
            }
            
            .main-content.sidebar-open {
                margin-left: 0;
            }
        }

        /* –ö–∞–ª–µ–Ω–¥–∞—Ä—å —É–ª—É—á—à–µ–Ω–∏—è */
        .calendar-stopwatch {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            text-align: center;
        }

        .calendar-stopwatch-time {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .calendar-stopwatch-controls {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .calendar-stopwatch-btn {
            background: rgba(255, 255, 255, 0.3);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
        }

        .calendar-stopwatch-btn:hover {
            background: rgba(255, 255, 255, 0.4);
        }

        .calendar-weather {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            text-align: center;
        }

        .calendar-weather-icon {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }

        .calendar-weather-temp {
            font-weight: 600;
        }

        /* ==================== –°–¢–ò–õ–ò –î–õ–Ø –í–´–î–ï–õ–ï–ù–ò–Ø –ü–û–ò–°–ö–ê ==================== */

        /* –í—ã–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ */
        .search-highlight {
            animation: highlightPulse 2s ease-in-out infinite;
            position: relative;
            border: 2px solid #81c784 !important;
            background: linear-gradient(135deg, rgba(129, 199, 132, 0.1) 0%, rgba(129, 199, 132, 0.2) 100%) !important;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(129, 199, 132, 0.3);
            z-index: 10;
        }

        .search-highlight::before {
            content: 'üîç –ù–∞–π–¥–µ–Ω–æ';
            position: absolute;
            top: -12px;
            right: -10px;
            background: linear-gradient(135deg, var(--accent-green) 0%, var(--dark-green) 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        @keyframes highlightPulse {
            0% {
                box-shadow: 0 0 0 0 rgba(129, 199, 132, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(129, 199, 132, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(129, 199, 132, 0);
            }
        }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞–π–¥–µ–Ω–Ω–æ–º —ç–ª–µ–º–µ–Ω—Ç–µ */
        .search-highlight-notification {
            animation: slideInRight 0.3s ease-out;
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-left: 4px solid #81c784;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* –£–ª—É—á—à–µ–Ω–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ */
        .search-result-item {
            border-left: 3px solid var(--success);
            margin-bottom: 2px;
            border-radius: 8px !important;
            transition: all 0.2s ease;
        }

        .search-result-item:hover {
            transform: translateX(5px);
        }
    </style>
</head>
<body class="fade-in">
    <!-- –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ -->
    <nav class="navbar navbar-expand-lg navbar-light fixed-top">
        <div class="container-fluid">
            <!-- –ö–Ω–æ–ø–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª—å—é -->
            <button class="btn sidebar-control d-none d-md-flex" id="sidebarControl" title="–°–∫—Ä—ã—Ç—å/–ø–æ–∫–∞–∑–∞—Ç—å –ø–∞–Ω–µ–ª—å">
                <i class="fas fa-bars"></i>
            </button>
            
            <!-- –ß–∞—Å—ã –∏ –≥–æ—Ä–æ–¥ -->
            <div class="navbar-brand d-flex align-items-center" id="timeSection">
                <div class="d-flex align-items-center">
                    <i class="fas fa-clock me-3" style="color: var(--dark-green); font-size: 1.3rem;"></i>
                    <div>
                        <div class="clock-time" id="currentTime">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                        <div class="clock-date" id="currentDate"></div>
                    </div>
                </div>
                <div class="city-badge">
                    <i class="fas fa-map-marker-alt"></i>
                    <span id="cityName">–ê—Å—Ç–∞–Ω–∞</span>
                </div>
            </div>
            
            <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
            <div class="calendar-dropdown" id="calendarDropdown">
                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button id="prevMonth"><i class="fas fa-chevron-left"></i></button>
                        <div class="calendar-current-date" id="calendarMonthYear">–Ø–Ω–≤–∞—Ä—å 2024</div>
                        <button id="nextMonth"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="calendar-time-display" id="calendarTime">00:00:00</div>
                    <div class="calendar-time-label">
                        <span>–ß–∞—Å—ã</span>
                        <span>–ú–∏–Ω—É—Ç—ã</span>
                        <span>–°–µ–∫—É–Ω–¥—ã</span>
                    </div>
                    
                    <!-- –°–µ–∫—É–Ω–¥–æ–º–µ—Ä -->
                    <div class="calendar-stopwatch">
                        <div class="calendar-stopwatch-time" id="stopwatchTime">00:00:00</div>
                        <div class="calendar-stopwatch-controls">
                            <button class="calendar-stopwatch-btn" id="startStopwatch">‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç</button>
                            <button class="calendar-stopwatch-btn" id="pauseStopwatch">‚è∏Ô∏è –ü–∞—É–∑–∞</button>
                            <button class="calendar-stopwatch-btn" id="resetStopwatch">üîÑ –°–±—Ä–æ—Å</button>
                        </div>
                    </div>
                </div>
                
                <!-- –°–æ–±—ã—Ç–∏—è -->
                <div class="calendar-events" id="calendarEvents">
                    <div class="calendar-event">
                        <div class="calendar-event-time">10:00</div>
                        <div>–ö–æ—Ä–º–ª–µ–Ω–∏–µ –∂–∏–≤–æ—Ç–Ω—ã—Ö</div>
                    </div>
                    <div class="calendar-event">
                        <div class="calendar-event-time">14:00</div>
                        <div>–ü–æ–ª–∏–≤ –ø–æ–ª–µ–π</div>
                    </div>
                    <div class="calendar-event">
                        <div class="calendar-event-time">16:00</div>
                        <div>–í—Å—Ç—Ä–µ—á–∞ —Å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞–º–∏</div>
                    </div>
                </div>
                
                <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
                <div class="calendar-body">
                    <div class="calendar-weekdays">
                        <div class="calendar-weekday">–ü–Ω</div>
                        <div class="calendar-weekday">–í—Ç</div>
                        <div class="calendar-weekday">–°—Ä</div>
                        <div class="calendar-weekday">–ß—Ç</div>
                        <div class="calendar-weekday">–ü—Ç</div>
                        <div class="calendar-weekday">–°–±</div>
                        <div class="calendar-weekday">–í—Å</div>
                    </div>
                    <div class="calendar-days" id="calendarDays">
                        <!-- –î–Ω–∏ –±—É–¥—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã JavaScript -->
                    </div>
                </div>
                
                
                <div class="calendar-footer">
                    <button class="btn btn-sm btn-outline-success" id="addEvent">
                        <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" id="closeCalendar">
                        <i class="fas fa-times"></i> –ó–∞–∫—Ä—ã—Ç—å
                    </button>
                </div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ –ò–≥—Ä—ã -->
            <a href="{{ url_for('game') }}" class="btn game-button">
                <i class="fas fa-gamepad"></i>
                <span>–ò–≥—Ä–∞</span>
                <span class="game-badge">üéÆ</span>
            </a>
            
            <!-- –ü–æ–∏—Å–∫ -->
            <div class="search-container flex-grow-1">
                <div class="input-group">
                    <input type="text" 
                           class="form-control" 
                           id="globalSearch" 
                           placeholder="–ü–æ–∏—Å–∫ –ø–æ –∂–∏–≤–æ—Ç–Ω—ã–º, –∑–∞–¥–∞—á–∞–º, –ø–æ–ª—è–º..."
                           aria-label="–ü–æ–∏—Å–∫">
                    <button class="btn btn-primary" type="button" id="searchButton">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
                
                <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ -->
                <div class="search-results" id="searchResults">
                    <div class="list-group list-group-flush">
                        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
                    </div>
                </div>
            </div>
            
            <!-- –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
            <div class="dropdown user-dropdown">
                <button class="btn dropdown-toggle d-flex align-items-center" 
                        type="button" 
                        id="userDropdown" 
                        data-bs-toggle="dropdown" 
                        aria-expanded="false">
                    <div class="me-3 text-end">
                        <div class="user-name">{{ session.full_name }}</div>
                        <div class="user-role">{{ session.role }}</div>
                    </div>
                    <i class="fas fa-user-circle fs-4" style="color: var(--dark-green);"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                    <li>
                        <a class="dropdown-item" href="{{ url_for('profile') }}">
                            <i class="fas fa-user me-2"></i>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å
                        </a>
                    </li>
                    {% if session.role == 'admin' %}
                    <li>
                        <a class="dropdown-item" href="{{ url_for('users') }}">
                            <i class="fas fa-users-cog me-2"></i>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
                        </a>
                    </li>
                    <!-- –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–∞ —Å—é–¥–∞ -->
                    <li>
                        <a class="dropdown-item" href="{{ url_for('logs') }}">
                            <i class="fas fa-history me-2"></i>–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π
                        </a>
                    </li>
                    {% endif %}
                    <li><hr class="dropdown-divider"></li>
                    <li>
                        <a class="dropdown-item dropdown-item-danger" href="{{ url_for('logout') }}">
                            <i class="fas fa-sign-out-alt me-2"></i>–í—ã–π—Ç–∏
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-content">
            <h4 class="mb-4 text-center" style="color: var(--dark-green);">
                <i class="fas fa-tractor"></i><br>
                Agro Farm
            </h4>
            
            <a href="{{ url_for('dashboard') }}" class="{% if request.endpoint == 'dashboard' %}active{% endif %}">
                <i class="fas fa-home me-2"></i>–ì–ª–∞–≤–Ω–∞—è
            </a>
            
            <a href="{{ url_for('animals') }}" class="{% if request.endpoint == 'animals' %}active{% endif %}">
                <span>üêÑ</span><span class="ms-2">–ñ–∏–≤–æ—Ç–Ω—ã–µ</span>
            </a>
            <a href="{{ url_for('meat') }}" class="{% if request.endpoint == 'meat' %}active{% endif %}">
                <i class="fas fa-drumstick-bite me-2"></i>–ú—è—Å–æ
            </a>
            <a href="{{ url_for('fields') }}" class="{% if request.endpoint == 'fields' %}active{% endif %}">
                <i class="fas fa-tractor me-2"></i>–ü–æ–ª—è
            </a>
            <a href="{{ url_for('storage') }}" class="{% if request.endpoint == 'storage' %}active{% endif %}">
                <i class="fas fa-warehouse me-2"></i>–°–∫–ª–∞–¥ –∫–æ—Ä–º–æ–≤
            </a>
            <a href="{{ url_for('machinery') }}" class="{% if request.endpoint == 'machinery' %}active{% endif %}">
                <i class="fas fa-tools me-2"></i>–¢–µ—Ö–Ω–∏–∫–∞
            </a>
            
            {% if session.role in ['admin', 'manager'] %}
            <a href="{{ url_for('finance') }}" class="{% if request.endpoint == 'finance' %}active{% endif %}">
                <i class="fas fa-money-bill me-2"></i>–§–∏–Ω–∞–Ω—Å—ã
            </a>
            {% endif %}
            
            <a href="{{ url_for('tasks') }}" class="{% if request.endpoint == 'tasks' %}active{% endif %}">
                <i class="fas fa-tasks me-2"></i>–ó–∞–¥–∞—á–∏
            </a>

            {% if session.role == 'admin' %}
            <a href="{{ url_for('users') }}" class="{% if request.endpoint == 'users' %}active{% endif %}">
                <i class="fas fa-users me-2"></i>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏
            </a>
            {% endif %}
            
            {% if session.role in ['admin', 'manager'] %}
            <a href="{{ url_for('orders') }}" class="{% if request.endpoint == 'orders' %}active{% endif %}">
                <i class="fas fa-shopping-cart me-2"></i>–ó–∞–∫–∞–∑—ã
            </a>
            {% endif %}
            
            <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ –∏–≥—Ä—É —É–¥–∞–ª–µ–Ω–∞ –∏–∑ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ (—Ç–µ–ø–µ—Ä—å –≤ –≤–µ—Ä—Ö–Ω–µ–π –ø–∞–Ω–µ–ª–∏) -->
            
            {% if session.role in ['admin', 'manager'] %}
            <a href="{{ url_for('export_all_excel') }}" class="btn btn-success btn-sm mt-3 w-100">
                <i class="fas fa-file-excel me-2"></i>–≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
            </a>
            {% endif %}
            
            <hr class="my-4" style="border-color: var(--border-color);">
            
            <div class="small" style="color: var(--text-light);">
                <i class="fas fa-user me-2"></i>{{ session.full_name }}<br>
                <i class="fas fa-shield-alt me-2"></i>{{ session.role }}
            </div>

            <a href="{{ url_for('logout') }}" class="btn btn-outline-success btn-sm mt-3 w-100">
                <i class="fas fa-sign-out-alt me-2"></i>–í—ã–π—Ç–∏
            </a>
        </div>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø–æ–∫–∞–∑–∞ –ø–∞–Ω–µ–ª–∏ -->
    <button class="mobile-sidebar-toggle" id="mobileSidebarToggle" title="–ü–æ–∫–∞–∑–∞—Ç—å –º–µ–Ω—é">
        <i class="fas fa-bars"></i>
    </button>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="main-content" id="mainContent">
        <div class="container-fluid">
            <div class="p-4">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è -->
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ category }} alert-dismissible fade show">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}

                {% block content %}{% endblock %}
            </div>
        </div>

        <!-- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —á–∞—Ç -->
        <div class="simple-chat-widget">
            <div class="chat-icon" onclick="toggleChat()">
                <i class="fas fa-comments"></i>
                <span class="chat-notification" id="chatNotification">0</span>
            </div>
            
            <div class="chat-window" id="chatWindow">
                <div class="chat-header">
                    <div class="chat-header-left">
                        <h6 class="chat-title" id="chatTitle">–û–±—â–∏–π —á–∞—Ç</h6>
                        <div class="chat-select-wrapper">
                            <select id="chatSelector" class="chat-select" onchange="changeActiveChat(event)">
                                <option value="global">–û–±—â–∏–π —á–∞—Ç</option>
                            </select>
                            <i class="fas fa-chevron-down select-arrow"></i>
                        </div>
                    </div>
                    <div class="chat-controls">
                        <!-- –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ —á–∞—Ç (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                        <button class="back-to-chat-btn d-none" id="backToChatBtn" onclick="backToChat()" title="–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —á–∞—Ç—É">
                            <i class="fas fa-arrow-left"></i>
                            <span>–ù–∞–∑–∞–¥ –∫ —á–∞—Ç—É</span>
                        </button>
                        <button class="chat-btn" id="clearChatBtn" onclick="clearChat()" title="–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                        <button class="chat-btn" onclick="toggleChat()" title="–ó–∞–∫—Ä—ã—Ç—å">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-loading">
                        <div class="spinner-border" role="status" style="color: var(--accent-green);">
                            <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                        </div>
                        <p>–ó–∞–≥—Ä—É–∑–∫–∞ —á–∞—Ç–∞...</p>
                    </div>
                </div>
                
                <!-- –ë–ª–æ–∫ –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ –Ω–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è) -->
                <div class="permission-request-area" id="permissionRequestArea" style="display: none;">
                    <div class="permission-request-card">
                        <div class="permission-header">
                            <i class="fas fa-lock"></i>
                            <h6>–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ</h6>
                        </div>
                        <div class="permission-message">
                            –î–ª—è –æ–±—â–µ–Ω–∏—è —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ.
                            –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ–±—Ä–∞—â–µ–Ω–∏—è:
                        </div>
                        <textarea class="permission-textarea" 
                                  id="permissionMessage" 
                                  placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –Ω—É–∂–Ω–æ –æ–±—Å—É–¥–∏—Ç—å —Å—Ä–æ—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å –ø–æ –∑–∞–∫–∞–∑—É..."
                                  rows="3"></textarea>
                        <div class="permission-buttons">
                            <button class="btn btn-success btn-sm" onclick="sendPermissionRequest()">
                                <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deletePermissionRequest()">
                                <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å –∑–∞–ø—Ä–æ—Å
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="cancelPermissionRequest()">
                                –û—Ç–º–µ–Ω–∞
                            </button>
                        </div>
                        <div class="permission-status mt-2" id="permissionStatus"></div>
                    </div>
                </div>
                
                <!-- –ë–ª–æ–∫ –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∞–¥–º–∏–Ω–∞ (—Å–∫—Ä—ã—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                <div class="time-selection-area" id="timeSelectionArea" style="display: none;">
                    <div class="time-selection-card">
                        <div class="time-selection-header">
                            <i class="fas fa-clock"></i>
                            <h6>–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ä–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è</h6>
                        </div>
                        <div class="time-options">
                            <button class="time-option" onclick="selectTime('10min')">
                                <div class="time-duration">10 –º–∏–Ω—É—Ç</div>
                                <div class="time-icon">‚è±Ô∏è</div>
                            </button>
                            <button class="time-option" onclick="selectTime('30min')">
                                <div class="time-duration">30 –º–∏–Ω—É—Ç</div>
                                <div class="time-icon">‚è∞</div>
                            </button>
                            <button class="time-option" onclick="selectTime('1hour')">
                                <div class="time-duration">1 —á–∞—Å</div>
                                <div class="time-icon">üïê</div>
                            </button>
                            <button class="time-option" onclick="selectTime('permanent')">
                                <div class="time-duration">–ë–µ—Å—Å—Ä–æ—á–Ω–æ</div>
                                <div class="time-icon">‚àû</div>
                            </button>
                            <button class="time-option" onclick="showCustomTime()">
                                <div class="time-duration">–°–≤–æ–π —Å—Ä–æ–∫</div>
                                <div class="time-icon">‚úèÔ∏è</div>
                            </button>
                        </div>
                        <div class="custom-time-area" id="customTimeArea" style="display: none;">
                            <div class="input-group mt-2">
                                <input type="number" 
                                       class="form-control" 
                                       id="customMinutes" 
                                       placeholder="–í–≤–µ–¥–∏—Ç–µ –º–∏–Ω—É—Ç—ã"
                                       min="1" max="1440">
                                <span class="input-group-text">–º–∏–Ω—É—Ç</span>
                                <button class="btn btn-success" onclick="selectCustomTime()">
                                    OK
                                </button>
                            </div>
                        </div>
                        <div class="time-selection-buttons mt-3">
                            <button class="btn btn-outline-secondary btn-sm" onclick="cancelTimeSelection()">
                                –û—Ç–º–µ–Ω–∞
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="chat-input-area" id="chatInputArea">
                    <div class="chat-input-row">
                        <input type="text" class="chat-input" id="chatInput" 
                               placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="handleChatKeyPress(event)">
                        <button class="send-btn" onclick="sendChatMessage()" id="sendBtn">
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å
                        </button>
                    </div>
                    <div class="chat-buttons-row">
                        <!-- –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
                        <button class="requests-btn d-none" id="requestsButton" onclick="showRequests()" title="–ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –æ–±—â–µ–Ω–∏–µ">
                            <i class="fas fa-envelope"></i>
                            <span>–ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –æ–±—â–µ–Ω–∏–µ</span>
                            <span class="requests-count-badge" id="requestsCount">0</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    {% block scripts %}{% endblock %}
    
    <script>
        // –ö–∞–ª–µ–Ω–¥–∞—Ä—å –∏ –≤—Ä–µ–º—è
        let currentDate = new Date();
        let calendarOpen = false;
        let stopwatchRunning = false;
        let stopwatchStartTime = 0;
        let stopwatchElapsedTime = 0;
        let stopwatchInterval = null;

        // –û—Ç–∫—Ä—ã—Ç–∏–µ/–∑–∞–∫—Ä—ã—Ç–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        document.getElementById('timeSection').addEventListener('click', function(e) {
            e.stopPropagation();
            const calendar = document.getElementById('calendarDropdown');
            calendar.classList.toggle('show');
            calendarOpen = !calendarOpen;
            
            if (calendarOpen) {
                generateCalendar(currentDate);
                updateCalendarTime();
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#calendarDropdown') && !e.target.closest('#timeSection')) {
                const calendar = document.getElementById('calendarDropdown');
                calendar.classList.remove('show');
                calendarOpen = false;
            }
        });

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è –ø–æ –∫–Ω–æ–ø–∫–µ
        document.getElementById('closeCalendar').addEventListener('click', function() {
            document.getElementById('calendarDropdown').classList.remove('show');
            calendarOpen = false;
        });

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        function generateCalendar(date) {
            const year = date.getFullYear();
            const month = date.getMonth();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
            const monthNames = [
                '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
                '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
            ];
            document.getElementById('calendarMonthYear').textContent = 
                `${monthNames[month]} ${year}`;
            
            // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—ã–π –∏ –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å –º–µ—Å—è—Ü–∞
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            
            // –ü–æ–ª—É—á–∞–µ–º –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è (0 - –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ, 1 - –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫)
            let firstDayOfWeek = firstDay.getDay();
            if (firstDayOfWeek === 0) firstDayOfWeek = 7; // –î–µ–ª–∞–µ–º –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ –ø–µ—Ä–≤—ã–º –¥–Ω–µ–º
            
            // –û—á–∏—â–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–Ω–µ–π
            const daysContainer = document.getElementById('calendarDays');
            daysContainer.innerHTML = '';
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –¥–ª—è –¥–Ω–µ–π –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
            for (let i = 1; i < firstDayOfWeek; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day other-month';
                daysContainer.appendChild(emptyDay);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –¥–Ω–∏ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—è—Ü–∞
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –¥–µ–Ω—å —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–º
                if (day === today.getDate() && 
                    month === today.getMonth() && 
                    year === today.getFullYear()) {
                    dayElement.classList.add('today');
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–±—ã—Ç–∏—è –Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –¥–Ω–∏
                if (day % 7 === 0 || day % 5 === 0) {
                    dayElement.classList.add('has-events');
                }
                
                dayElement.addEventListener('click', function() {
                    // –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —É –≤—Å–µ—Ö –¥–Ω–µ–π
                    document.querySelectorAll('.calendar-day').forEach(d => {
                        d.classList.remove('selected');
                    });
                    // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –¥–µ–Ω—å
                    this.classList.add('selected');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–Ω—è
                    showEventsForDay(day, month, year);
                });
                
                daysContainer.appendChild(dayElement);
            }
        }

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º
        document.getElementById('prevMonth').addEventListener('click', function() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            generateCalendar(currentDate);
        });

        document.getElementById('nextMonth').addEventListener('click', function() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            generateCalendar(currentDate);
        });

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
        function updateCalendarTime() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const seconds = now.getSeconds().toString().padStart(2, '0');
            
            document.getElementById('calendarTime').textContent = `${hours}:${minutes}:${seconds}`;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É, –µ—Å–ª–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—å –æ—Ç–∫—Ä—ã—Ç
            if (calendarOpen) {
                setTimeout(updateCalendarTime, 1000);
            }
        }

        // –ü–æ–∫–∞–∑ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –¥–Ω—è
        function showEventsForDay(day, month, year) {
            const events = [
                { time: '09:00', title: '–£—Ç—Ä–µ–Ω–Ω—è—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∂–∏–≤–æ—Ç–Ω—ã—Ö' },
                { time: '12:00', title: '–û–±–µ–¥' },
                { time: '15:00', title: '–†–∞–±–æ—Ç–∞ –≤ –ø–æ–ª—è—Ö' },
                { time: '18:00', title: '–í–µ—á–µ—Ä–Ω–∏–π –æ—Ç—á–µ—Ç' }
            ];
            
            const eventsContainer = document.getElementById('calendarEvents');
            eventsContainer.innerHTML = '';
            
            events.forEach(event => {
                const eventElement = document.createElement('div');
                eventElement.className = 'calendar-event';
                eventElement.innerHTML = `
                    <div class="calendar-event-time">${event.time}</div>
                    <div>${event.title}</div>
                `;
                eventsContainer.appendChild(eventElement);
            });
        }

        // –°–µ–∫—É–Ω–¥–æ–º–µ—Ä
        function updateStopwatch() {
            if (!stopwatchRunning) return;
            
            const currentTime = Date.now();
            const elapsed = stopwatchElapsedTime + (currentTime - stopwatchStartTime);
            
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            const milliseconds = Math.floor((elapsed % 1000) / 10);
            
            document.getElementById('stopwatchTime').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}.${milliseconds.toString().padStart(2, '0')}`;
            
            if (stopwatchRunning) {
                requestAnimationFrame(updateStopwatch);
            }
        }

        document.getElementById('startStopwatch').addEventListener('click', function() {
            if (!stopwatchRunning) {
                stopwatchRunning = true;
                stopwatchStartTime = Date.now();
                updateStopwatch();
            }
        });

        document.getElementById('pauseStopwatch').addEventListener('click', function() {
            if (stopwatchRunning) {
                stopwatchRunning = false;
                stopwatchElapsedTime += Date.now() - stopwatchStartTime;
            }
        });

        document.getElementById('resetStopwatch').addEventListener('click', function() {
            stopwatchRunning = false;
            stopwatchElapsedTime = 0;
            document.getElementById('stopwatchTime').textContent = '00:00:00.00';
        });

        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è
        document.getElementById('addEvent').addEventListener('click', function() {
            const title = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è:');
            if (title) {
                const time = prompt('–í–≤–µ–¥–∏—Ç–µ –≤—Ä–µ–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 14:30):');
                if (time) {
                    const eventsContainer = document.getElementById('calendarEvents');
                    const eventElement = document.createElement('div');
                    eventElement.className = 'calendar-event';
                    eventElement.innerHTML = `
                        <div class="calendar-event-time">${time}</div>
                        <div>${title}</div>
                    `;
                    eventsContainer.appendChild(eventElement);
                }
            }
        });

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
        let sidebarOpen = localStorage.getItem('sidebarOpen') !== 'false'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –æ—Ç–∫—Ä—ã—Ç–∞
        
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const sidebarControl = document.getElementById('sidebarControl');
            
            sidebarOpen = !sidebarOpen;
            
            if (sidebarOpen) {
                sidebar.classList.add('show');
                sidebar.classList.remove('collapsed');
                mainContent.classList.add('sidebar-open');
                mainContent.classList.remove('sidebar-closed');
                sidebarControl.innerHTML = '<i class="fas fa-bars"></i>';
            } else {
                sidebar.classList.remove('show');
                sidebar.classList.add('collapsed');
                mainContent.classList.remove('sidebar-open');
                mainContent.classList.add('sidebar-closed');
                sidebarControl.innerHTML = '<i class="fas fa-bars"></i>';
            }
            
            localStorage.setItem('sidebarOpen', sidebarOpen);
        }
        
        function initSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            const sidebarControl = document.getElementById('sidebarControl');
            const mobileToggle = document.getElementById('mobileSidebarToggle');
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            if (sidebarOpen) {
                sidebar.classList.add('show');
                mainContent.classList.add('sidebar-open');
                sidebarControl.innerHTML = '<i class="fas fa-bars"></i>';
            } else {
                sidebar.classList.add('collapsed');
                mainContent.classList.add('sidebar-closed');
                sidebarControl.innerHTML = '<i class="fas fa-bars"></i>';
            }
            
            // –î–µ—Å–∫—Ç–æ–ø–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å
            sidebarControl.addEventListener('click', toggleSidebar);
            
            // –ú–æ–±–∏–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª—å
            if (mobileToggle) {
                mobileToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('show');
                    mobileToggle.innerHTML = sidebar.classList.contains('show') ? 
                        '<i class="fas fa-times"></i>' : '<i class="fas fa-bars"></i>';
                });
            }
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–∞–Ω–µ–ª–∏ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
            document.addEventListener('click', function(e) {
                if (window.innerWidth <= 768) {
                    if (!sidebar.contains(e.target) && 
                        !mobileToggle.contains(e.target) && 
                        sidebar.classList.contains('show')) {
                        sidebar.classList.remove('show');
                        mobileToggle.innerHTML = '<i class="fas fa-bars"></i>';
                    }
                }
            });
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ (—á–∞—Å—ã, –º–∏–Ω—É—Ç—ã, –¥–∞—Ç–∞)
        function updateClock() {
            const now = new Date();
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ (—á—á:–º–º)
            const timeString = now.toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞—Ç—ã
            const dateString = now.toLocaleDateString('ru-RU', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            document.getElementById('currentTime').textContent = timeString;
            document.getElementById('currentDate').textContent = dateString;
        }
        
        // –ü–æ–∏—Å–∫ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
        let searchTimeout;
        async function performSearch(query) {
            if (query.length < 2) {
                document.getElementById('searchResults').style.display = 'none';
                return;
            }
            
            try {
                const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                const resultsContainer = document.getElementById('searchResults');
                const resultsList = resultsContainer.querySelector('.list-group');
                
                if (data.results && data.results.length > 0) {
                    resultsList.innerHTML = '';
                    
                    data.results.forEach(result => {
                        const item = document.createElement('a');
                        item.href = result.url;
                        item.className = 'list-group-item list-group-item-action';
                        
                        // –ò–∫–æ–Ω–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
                        let icon = 'fa-paw';
                        let color = 'success';
                        if (result.type === 'task') {
                            icon = 'fa-tasks';
                            color = 'warning';
                        }
                        if (result.type === 'field') {
                            icon = 'fa-tractor';
                            color = 'success';
                        }
                        
                        item.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas ${icon} me-2 text-${color}"></i>
                                    <strong>${result.name}</strong>
                                    <div class="small text-muted mt-1">${result.details}</div>
                                </div>
                                <span class="badge bg-${color}">${result.type_name}</span>
                            </div>
                        `;
                        
                        resultsList.appendChild(item);
                    });
                    
                    resultsContainer.style.display = 'block';
                } else {
                    resultsList.innerHTML = `
                        <div class="list-group-item text-center text-muted py-4">
                            <i class="fas fa-search fa-lg mb-3 opacity-50"></i>
                            <div>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                            <small class="text-muted">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å</small>
                        </div>
                    `;
                    resultsContainer.style.display = 'block';
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞:', error);
            }
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            // –ó–∞–ø—É—Å–∫ —á–∞—Å–æ–≤
            updateClock();
            setInterval(updateClock, 1000); // –û–±–Ω–æ–≤–ª—è—Ç—å –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏
            initSidebar();
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞
            const searchInput = document.getElementById('globalSearch');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        performSearch(e.target.value);
                    }, 300);
                });
                
                // –°–∫—Ä—ã—Ç–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –ø–æ–ª—è –ø–æ–∏—Å–∫–∞
                document.addEventListener('click', function(e) {
                    if (!e.target.closest('.search-container')) {
                        document.getElementById('searchResults').style.display = 'none';
                    }
                });
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –ø–æ–∏—Å–∫–∞
                document.getElementById('searchButton').addEventListener('click', function() {
                    performSearch(searchInput.value);
                });
            }
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            document.body.classList.add('fade-in');
            
            // –ê–¥–∞–ø—Ç–∞—Ü–∏—è –∫ –º–æ–±–∏–ª—å–Ω—ã–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º
            function handleResize() {
                const mobileToggle = document.getElementById('mobileSidebarToggle');
                if (window.innerWidth <= 768) {
                    if (mobileToggle) mobileToggle.style.display = 'flex';
                } else {
                    if (mobileToggle) mobileToggle.style.display = 'none';
                }
            }
            
            window.addEventListener('resize', handleResize);
            handleResize(); // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–π –≤—ã–∑–æ–≤
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –≤ –∫–∞–ª–µ–Ω–¥–∞—Ä–µ
            generateCalendar(currentDate);
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ –ø–æ–∏—Å–∫–∞, –µ—Å–ª–∏ –µ—Å—Ç—å
            setTimeout(() => {
                applySearchHighlight();
            }, 500);
        });

        // ==================== –ö–û–î –ß–ê–¢–ê ====================
        let chatOpen = false;
        let messageCount = 0;
        let currentUserId = "{{ session.user_id|default('') }}";
        let currentUsername = "{{ session.username|default('–ì–æ—Å—Ç—å') }}";
        let currentFullName = "{{ session.full_name|default('–ì–æ—Å—Ç—å') }}";
        let currentRole = "{{ session.role|default('guest') }}";
        let currentChatType = 'global';
        let currentPrivateChatId = null;
        let selectedRequestId = null;
        let selectedExpiresIn = null;
        let isRequestsMode = false;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∫–æ–Ω–∫–∏ —á–∞—Ç–∞
        function updateChatIconNotification(count) {
            const notification = document.getElementById('chatNotification');
            if (count > 0) {
                notification.textContent = count > 99 ? '99+' : count;
                notification.style.display = 'flex';
                
                const chatIcon = document.querySelector('.chat-icon');
                chatIcon.style.animation = 'pulse-glow 2s infinite';
            } else {
                notification.style.display = 'none';
                const chatIcon = document.querySelector('.chat-icon');
                chatIcon.style.animation = '';
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —á–∞—Ç–∞
        function toggleChat() {
            const chatWindow = document.getElementById('chatWindow');
            chatOpen = !chatOpen;
            
            if (chatOpen) {
                chatWindow.classList.add('show');
                document.getElementById('chatNotification').style.display = 'none';
                messageCount = 0;
                
                loadAvailableChats();
                loadChatMessages();
                document.getElementById('chatInput').focus();
                
                // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ä–µ–∂–∏–º –∑–∞–ø—Ä–æ—Å–æ–≤
                if (isRequestsMode) {
                    backToChat();
                }
            } else {
                chatWindow.classList.remove('show');
                hideTimeSelection();
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ —á–∞—Ç—ã
        async function loadAvailableChats() {
            try {
                const response = await fetch('/get_available_chats');
                if (!response.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤');
                
                const chats = await response.json();
                const chatSelector = document.getElementById('chatSelector');
                
                const currentValue = chatSelector.value;
                
                // –û—á–∏—â–∞–µ–º –≤—Å–µ –æ–ø—Ü–∏–∏ –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π (–æ–±—â–∏–π —á–∞—Ç)
                while (chatSelector.options.length > 1) {
                    chatSelector.remove(1);
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/—Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                const requestsBtn = document.getElementById('requestsButton');
                if (currentRole === 'admin') {
                    requestsBtn.classList.remove('d-none');
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–∂–∏–¥–∞—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
                    await updateRequestsCount();
                } else {
                    requestsBtn.classList.add('d-none');
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º —á–∞—Ç—ã
                chats.forEach(chat => {
                    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã "–û–±—â–∏–π —á–∞—Ç"
                    if (chat.name === '–û–±—â–∏–π —á–∞—Ç' || chat.id === 'global') {
                        return;
                    }
                    
                    const option = document.createElement('option');
                    option.value = chat.id;
                    
                    let text = chat.name;
                    if (chat.role === 'admin') {
                        text += ' üëë';
                    }
                    
                    if (chat.unread > 0) {
                        text += ` üîî ${chat.unread}`;
                    }
                    
                    option.textContent = text;
                    chatSelector.appendChild(option);
                });
                
                chatSelector.value = currentValue || 'global';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–æ–≤:', error);
            }
        }

        // –û–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤
        async function updateRequestsCount() {
            if (currentRole !== 'admin') return;
            
            try {
                const response = await fetch('/get_chat_requests');
                const requests = await response.json();
                
                if (!requests.error && requests.length > 0) {
                    const pendingCount = requests.filter(r => r.status === 'pending').length;
                    const requestsCountBadge = document.getElementById('requestsCount');
                    
                    if (pendingCount > 0) {
                        requestsCountBadge.textContent = pendingCount;
                        requestsCountBadge.style.display = 'inline-flex';
                        
                        // –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –∫ –∫–Ω–æ–ø–∫–µ
                        const requestsBtn = document.getElementById('requestsButton');
                        requestsBtn.classList.add('requests-glow');
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É —á–∞—Ç–∞
                        updateChatIconNotification(pendingCount);
                    } else {
                        requestsCountBadge.style.display = 'none';
                        const requestsBtn = document.getElementById('requestsButton');
                        requestsBtn.classList.remove('requests-glow');
                    }
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤:', error);
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã (–¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞)
        async function showRequests() {
            isRequestsMode = true;
            
            // –ú–µ–Ω—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            document.getElementById('chatTitle').textContent = 'üì® –ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –æ–±—â–µ–Ω–∏–µ';
            document.getElementById('chatSelector').classList.add('d-none');
            document.getElementById('requestsButton').classList.add('d-none');
            document.getElementById('backToChatBtn').classList.remove('d-none');
            document.getElementById('chatInputArea').style.display = 'none';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–ø—Ä–æ—Å—ã
            const chatMessages = document.getElementById('chatMessages');
            
            chatMessages.innerHTML = `
                <div class="chat-loading">
                    <div class="spinner-border" role="status" style="color: #ff9800;">
                        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤...</p>
                </div>
            `;
            
            try {
                const response = await fetch('/get_chat_requests');
                const requests = await response.json();
                
                if (requests.error) {
                    chatMessages.innerHTML = `
                        <div class="chat-empty">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤</p>
                            <small>${requests.error}</small>
                        </div>
                    `;
                    return;
                }
                
                chatMessages.innerHTML = '';
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                const titleDiv = document.createElement('div');
                titleDiv.className = 'chat-requests-section';
                titleDiv.innerHTML = `
                    <div class="chat-requests-title">
                        <i class="fas fa-envelope"></i>
                        <span>–ó–∞–ø—Ä–æ—Å—ã –Ω–∞ –æ–±—â–µ–Ω–∏–µ</span>
                        <span class="badge bg-warning">${requests.length}</span>
                    </div>
                `;
                chatMessages.appendChild(titleDiv);
                
                if (requests.length === 0) {
                    const emptyDiv = document.createElement('div');
                    emptyDiv.className = 'chat-requests-empty';
                    emptyDiv.innerHTML = `
                        <i class="far fa-envelope-open"></i>
                        <p>–ù–µ—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –æ–±—â–µ–Ω–∏–µ</p>
                        <small>–†–∞–±–æ—á–∏–µ –∏ –º–µ–Ω–µ–¥–∂–µ—Ä—ã –µ—â—ë –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª–∏ –∑–∞–ø—Ä–æ—Å–æ–≤</small>
                    `;
                    chatMessages.appendChild(emptyDiv);
                    return;
                }
                
                // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å–ø–∏—Å–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
                const listDiv = document.createElement('div');
                listDiv.className = 'chat-requests-list';
                
                // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –∑–∞–ø—Ä–æ—Å—ã
                const pendingRequests = requests.filter(r => r.status === 'pending');
                const approvedRequests = requests.filter(r => r.status === 'approved');
                const rejectedRequests = requests.filter(r => r.status === 'rejected');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∂–∏–¥–∞—é—â–∏–µ –∑–∞–ø—Ä–æ—Å—ã –ø–µ—Ä–≤—ã–º–∏
                if (pendingRequests.length > 0) {
                    pendingRequests.forEach(request => {
                        listDiv.appendChild(createRequestCard(request));
                    });
                }
                
                if (approvedRequests.length > 0) {
                    approvedRequests.forEach(request => {
                        listDiv.appendChild(createRequestCard(request));
                    });
                }
                
                if (rejectedRequests.length > 0) {
                    rejectedRequests.forEach(request => {
                        listDiv.appendChild(createRequestCard(request));
                    });
                }
                
                chatMessages.appendChild(listDiv);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤:', error);
                chatMessages.innerHTML = `
                    <div class="chat-empty">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤</p>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }

        // –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —á–∞—Ç—É
        function backToChat() {
            isRequestsMode = false;
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            document.getElementById('chatTitle').textContent = '–û–±—â–∏–π —á–∞—Ç';
            document.getElementById('chatSelector').classList.remove('d-none');
            document.getElementById('requestsButton').classList.remove('d-none');
            document.getElementById('backToChatBtn').classList.add('d-none');
            document.getElementById('chatInputArea').style.display = 'block';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è –æ–±—â–µ–≥–æ —á–∞—Ç–∞
            currentChatType = 'global';
            currentPrivateChatId = null;
            document.getElementById('chatSelector').value = 'global';
            loadChatMessages();
        }

        // –°–æ–∑–¥–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫—É –∑–∞–ø—Ä–æ—Å–∞
        function createRequestCard(request) {
            const card = document.createElement('div');
            card.className = `chat-request-card ${request.status}`;
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É
            const requestDate = new Date(request.created_at);
            const dateStr = requestDate.toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'long',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—É—é –±—É–∫–≤—É –∏–º–µ–Ω–∏ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∞
            const userInitial = request.full_name ? request.full_name[0].toUpperCase() : request.username[0].toUpperCase();
            
            // –¢–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º
            let statusText = '';
            let statusClass = '';
            switch(request.status) {
                case 'pending':
                    statusText = '–û–∂–∏–¥–∞–µ—Ç';
                    statusClass = 'pending';
                    break;
                case 'approved':
                    statusText = '–û–¥–æ–±—Ä–µ–Ω';
                    statusClass = 'approved';
                    break;
                case 'rejected':
                    statusText = '–û—Ç–∫–ª–æ–Ω—ë–Ω';
                    statusClass = 'rejected';
                    break;
            }
            
            // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –æ–¥–æ–±—Ä–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
            let timeInfo = '';
            if (request.status === 'approved' && request.expires_at) {
                const expiresDate = new Date(request.expires_at);
                const now = new Date();
                const diffMs = expiresDate - now;
                
                if (diffMs > 0) {
                    const diffMins = Math.floor(diffMs / 60000);
                    const diffHours = Math.floor(diffMins / 60);
                    const remainingMins = diffMins % 60;
                    
                    let timeText = '';
                    if (diffHours > 0) {
                        timeText = `${diffHours}—á ${remainingMins}–º`;
                    } else {
                        timeText = `${diffMins}–º`;
                    }
                    
                    timeInfo = `<div class="time-remaining"><i class="fas fa-clock"></i> –û—Å—Ç–∞–ª–æ—Å—å: ${timeText}</div>`;
                } else {
                    timeInfo = `<div class="time-remaining expired"><i class="fas fa-clock"></i> –ò—Å—Ç–µ–∫–ª–æ</div>`;
                }
            } else if (request.status === 'approved') {
                timeInfo = `<div class="time-remaining"><i class="fas fa-infinity"></i> –ë–µ—Å—Å—Ä–æ—á–Ω–æ</div>`;
            }
            
            card.innerHTML = `
                <div class="chat-request-header">
                    <div class="chat-request-user">
                        <div class="chat-request-user-avatar">
                            ${userInitial}
                        </div>
                        <div class="chat-request-user-info">
                            <h6>${request.full_name || request.username}</h6>
                            <small>${request.role}</small>
                        </div>
                    </div>
                    <div class="chat-request-status ${statusClass}">
                        ${statusText}
                    </div>
                </div>
                
                <div class="chat-request-message">
                    ${escapeHtml(request.message)}
                </div>
                
                ${timeInfo}
                
                <div class="chat-request-footer">
                    <div class="chat-request-time">
                        <i class="far fa-clock"></i> ${dateStr}
                    </div>
                    <div class="chat-request-actions">
                        ${request.status === 'pending' ? `
                            <button class="btn btn-approve btn-sm" onclick="showTimeSelection(${request.id})">
                                <i class="fas fa-check"></i> –û–¥–æ–±—Ä–∏—Ç—å
                            </button>
                            <button class="btn btn-reject btn-sm" onclick="respondToRequest(${request.id}, 'rejected')">
                                <i class="fas fa-times"></i> –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                            </button>
                        ` : ''}
                        <button class="btn btn-delete btn-sm" onclick="deleteAdminRequest(${request.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            return card;
        }

        // –°–º–µ–Ω–∏—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç
        async function changeActiveChat(event) {
            if (event) event.stopPropagation();
            
            const chatSelector = document.getElementById('chatSelector');
            const selectedValue = chatSelector.value;
            
            // –°–∫—Ä—ã–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –±–ª–æ–∫–∏
            document.getElementById('permissionRequestArea').style.display = 'none';
            document.getElementById('timeSelectionArea').style.display = 'none';
            
            if (selectedValue === 'global') {
                currentChatType = 'global';
                currentPrivateChatId = null;
                document.getElementById('chatTitle').textContent = '–û–±—â–∏–π —á–∞—Ç';
                document.getElementById('chatInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
                loadChatMessages();
            } else {
                const selectedOption = chatSelector.options[chatSelector.selectedIndex];
                currentChatType = 'private';
                currentPrivateChatId = selectedValue;
                
                let chatName = selectedOption.text.split(' üëë')[0];
                document.getElementById('chatTitle').textContent = chatName;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
                const isAdmin = selectedOption.text.includes('üëë');
                
                if (isAdmin && currentRole !== 'admin') {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –æ–±—â–µ–Ω–∏–µ —Å —ç—Ç–∏–º –∞–¥–º–∏–Ω–æ–º
                    await checkPermissionForAdmin(selectedValue);
                } else {
                    document.getElementById('chatInput').disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                    loadChatMessages();
                }
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
        async function checkPermissionForAdmin(adminId) {
            try {
                const response = await fetch(`/check_chat_permission/${adminId}`);
                const data = await response.json();
                
                if (data.has_permission) {
                    // –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –µ—Å—Ç—å - –∑–∞–≥—Ä—É–∂–∞–µ–º —á–∞—Ç
                    document.getElementById('chatInput').disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                    loadChatMessages();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Ä–µ–º–µ–Ω–∏
                    if (data.expires_at) {
                        showTimeRemaining(data.expires_at);
                    }
                } else {
                    // –†–∞–∑—Ä–µ—à–µ–Ω–∏—è –Ω–µ—Ç - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∑–∞–ø—Ä–æ—Å–∞
                    showPermissionRequestForm(adminId, data);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è:', error);
                document.getElementById('chatInput').disabled = false;
                document.getElementById('sendBtn').disabled = false;
                loadChatMessages();
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –≤—Ä–µ–º—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
        function showTimeRemaining(expiresAt) {
            const expiresDate = new Date(expiresAt);
            const now = new Date();
            const diffMs = expiresDate - now;
            
            if (diffMs > 0) {
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMins / 60);
                const remainingMins = diffMins % 60;
                
                let timeText = '';
                if (diffHours > 0) {
                    timeText = `${diffHours}—á ${remainingMins}–º`;
                } else {
                    timeText = `${diffMins}–º`;
                }
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤ —Å—Ç–∞—Ç—É—Å–µ
                const statusDiv = document.createElement('div');
                statusDiv.className = 'time-remaining';
                statusDiv.innerHTML = `<i class="fas fa-clock"></i> –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∏—Å—Ç–µ–∫–∞–µ—Ç —á–µ—Ä–µ–∑: ${timeText}`;
                
                const chatHeader = document.querySelector('.chat-header');
                if (chatHeader && !chatHeader.querySelector('.time-remaining')) {
                    chatHeader.appendChild(statusDiv);
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
                setTimeout(() => showTimeRemaining(expiresAt), 60000);
            } else {
                const statusDiv = document.createElement('div');
                statusDiv.className = 'time-remaining expired';
                statusDiv.innerHTML = `<i class="fas fa-clock"></i> –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∏—Å—Ç–µ–∫–ª–æ`;
                
                const chatHeader = document.querySelector('.chat-header');
                if (chatHeader && !chatHeader.querySelector('.time-remaining')) {
                    chatHeader.appendChild(statusDiv);
                }
            }
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
        function showPermissionRequestForm(adminId, permissionData) {
            const permissionArea = document.getElementById('permissionRequestArea');
            const statusDiv = document.getElementById('permissionStatus');
            
            document.getElementById('chatInput').disabled = true;
            document.getElementById('sendBtn').disabled = true;
            
            statusDiv.style.display = 'none';
            statusDiv.className = 'permission-status';
            statusDiv.textContent = '';
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π –∑–∞–ø—Ä–æ—Å
            if (permissionData.status === 'pending') {
                permissionArea.innerHTML = `
                    <div class="permission-request-card">
                        <div class="permission-header">
                            <i class="fas fa-clock"></i>
                            <h6>–ó–∞–ø—Ä–æ—Å –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–∏</h6>
                        </div>
                        <div class="permission-message">
                            –í—ã —É–∂–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±—â–µ–Ω–∏–µ —Å —ç—Ç–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.
                            –î–æ–∂–¥–∏—Ç–µ—Å—å, –ø–æ–∫–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç –≤–∞—à—É –∑–∞—è–≤–∫—É.
                        </div>
                        <div class="permission-buttons">
                            <button class="btn btn-danger btn-sm" onclick="deletePermissionRequest()">
                                <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å –∑–∞–ø—Ä–æ—Å
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="cancelPermissionRequest()">
                                –û—Ç–º–µ–Ω–∞
                            </button>
                        </div>
                        <div class="permission-status warning mt-2">
                            ‚è≥ –°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                        </div>
                    </div>
                `;
                permissionArea.style.display = 'block';
            } else if (permissionData.status === 'rejected') {
                permissionArea.innerHTML = `
                    <div class="permission-request-card">
                        <div class="permission-header">
                            <i class="fas fa-times-circle"></i>
                            <h6>–ó–∞–ø—Ä–æ—Å –æ—Ç–∫–ª–æ–Ω—ë–Ω</h6>
                        </div>
                        <div class="permission-message">
                            –í–∞—à –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–ø—Ä–æ—Å –±—ã–ª –æ—Ç–∫–ª–æ–Ω—ë–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.
                            –í—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å —Å –¥—Ä—É–≥–æ–π –ø—Ä–∏—á–∏–Ω–æ–π.
                        </div>
                        <textarea class="permission-textarea" 
                                  id="permissionMessage" 
                                  placeholder="–û–ø–∏—à–∏—Ç–µ –Ω–æ–≤—É—é –ø—Ä–∏—á–∏–Ω—É –¥–ª—è –æ–±—â–µ–Ω–∏—è..."
                                  rows="3"></textarea>
                        <div class="permission-buttons">
                            <button class="btn btn-success btn-sm" onclick="sendPermissionRequest()">
                                <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="cancelPermissionRequest()">
                                –û—Ç–º–µ–Ω–∞
                            </button>
                        </div>
                    </div>
                `;
                permissionArea.style.display = 'block';
            } else if (permissionData.status === 'expired') {
                permissionArea.innerHTML = `
                    <div class="permission-request-card">
                        <div class="permission-header">
                            <i class="fas fa-hourglass-end"></i>
                            <h6>–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∏—Å—Ç–µ–∫–ª–æ</h6>
                        </div>
                        <div class="permission-message">
                            –í–∞—à–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –æ–±—â–µ–Ω–∏–µ –∏—Å—Ç–µ–∫–ª–æ.
                            –û—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –æ–±—â–µ–Ω–∏—è.
                        </div>
                        <textarea class="permission-textarea" 
                                  id="permissionMessage" 
                                  placeholder="–û–ø–∏—à–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è –æ–±—â–µ–Ω–∏—è..."
                                  rows="3"></textarea>
                        <div class="permission-buttons">
                            <button class="btn btn-success btn-sm" onclick="sendPermissionRequest()">
                                <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="cancelPermissionRequest()">
                                –û—Ç–º–µ–Ω–∞
                            </button>
                        </div>
                    </div>
                `;
                permissionArea.style.display = 'block';
            } else {
                permissionArea.innerHTML = `
                    <div class="permission-request-card">
                        <div class="permission-header">
                            <i class="fas fa-lock"></i>
                            <h6>–¢—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ</h6>
                        </div>
                        <div class="permission-message">
                            –î–ª—è –æ–±—â–µ–Ω–∏—è —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º —Ç—Ä–µ–±—É–µ—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ.
                            –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ–±—Ä–∞—â–µ–Ω–∏—è:
                        </div>
                        <textarea class="permission-textarea" 
                                  id="permissionMessage" 
                                  placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –Ω—É–∂–Ω–æ –æ–±—Å—É–¥–∏—Ç—å —Å—Ä–æ—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å –ø–æ –∑–∞–∫–∞–∑—É..."
                                  rows="3"></textarea>
                        <div class="permission-buttons">
                            <button class="btn btn-success btn-sm" onclick="sendPermissionRequest()">
                                <i class="fas fa-paper-plane"></i> –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="cancelPermissionRequest()">
                                –û—Ç–º–µ–Ω–∞
                            </button>
                        </div>
                        <div class="permission-status" id="permissionStatus"></div>
                    </div>
                `;
                permissionArea.style.display = 'block';
                document.getElementById('permissionMessage').focus();
            }
        }

        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
        async function sendPermissionRequest() {
            const messageInput = document.getElementById('permissionMessage');
            const message = messageInput ? messageInput.value.trim() : '';
            const statusDiv = document.getElementById('permissionStatus');
            
            if (!message) {
                showStatus('error', '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–ø–∏—à–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –¥–ª—è –æ–±—â–µ–Ω–∏—è');
                return;
            }
            
            const adminId = currentPrivateChatId;
            if (!adminId) {
                showStatus('error', '‚ùå –û—à–∏–±–∫–∞: –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –Ω–µ –≤—ã–±—Ä–∞–Ω');
                return;
            }
            
            try {
                const response = await fetch('/request_chat_permission', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        admin_id: adminId,
                        message: message
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus('success', `‚úÖ ${result.message}<br><small>ID –∑–∞–ø—Ä–æ—Å–∞: ${result.request_id}</small>`);
                    
                    // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
                    if (messageInput) messageInput.value = '';
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
                    setTimeout(() => {
                        loadAvailableChats();
                    }, 2000);
                    
                } else {
                    showStatus('error', `‚ùå –û—à–∏–±–∫–∞: ${result.error}`);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–∞:', error);
                showStatus('error', '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
            }
        }

        // –£–¥–∞–ª–∏—Ç—å –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
        async function deletePermissionRequest() {
            if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–≤–æ–π –∑–∞–ø—Ä–æ—Å?')) {
                return;
            }
            
            try {
                // –ù–∞–º –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ ID –∑–∞–ø—Ä–æ—Å–∞
                const response = await fetch(`/check_chat_permission/${currentPrivateChatId}`);
                const data = await response.json();
                
                if (data.request_id) {
                    const deleteResponse = await fetch(`/delete_chat_request/${data.request_id}`, {
                        method: 'POST'
                    });
                    
                    const result = await deleteResponse.json();
                    
                    if (result.success) {
                        showStatus('success', '‚úÖ –ó–∞–ø—Ä–æ—Å —É–¥–∞–ª—ë–Ω!');
                        setTimeout(() => {
                            cancelPermissionRequest();
                            loadAvailableChats();
                        }, 1500);
                    } else {
                        showStatus('error', `‚ùå –û—à–∏–±–∫–∞: ${result.error}`);
                    }
                } else {
                    showStatus('error', '‚ùå –ù–µ –Ω–∞–π–¥–µ–Ω –∞–∫—Ç–∏–≤–Ω—ã–π –∑–∞–ø—Ä–æ—Å –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞:', error);
                showStatus('error', '‚ùå –û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞');
            }
        }

        // –û—Ç–º–µ–Ω–∞ –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
        function cancelPermissionRequest() {
            document.getElementById('permissionRequestArea').style.display = 'none';
            document.getElementById('chatSelector').value = 'global';
            changeActiveChat();
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –≤—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –∞–¥–º–∏–Ω–∞
        function showTimeSelection(requestId) {
            selectedRequestId = requestId;
            document.getElementById('timeSelectionArea').style.display = 'block';
        }

        // –°–∫—Ä—ã—Ç—å –≤—ã–±–æ—Ä –≤—Ä–µ–º–µ–Ω–∏
        function hideTimeSelection() {
            document.getElementById('timeSelectionArea').style.display = 'none';
            document.getElementById('customTimeArea').style.display = 'none';
            selectedRequestId = null;
            selectedExpiresIn = null;
        }

        // –í—ã–±—Ä–∞—Ç—å –≤—Ä–µ–º—è
        function selectTime(expiresIn) {
            selectedExpiresIn = expiresIn;
            respondToRequest(selectedRequestId, 'approved');
            hideTimeSelection();
        }

        // –ü–æ–∫–∞–∑–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω–æ–µ –≤—Ä–µ–º—è
        function showCustomTime() {
            document.getElementById('customTimeArea').style.display = 'block';
        }

        // –í—ã–±—Ä–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω–æ–µ –≤—Ä–µ–º—è
        function selectCustomTime() {
            const customMinutes = document.getElementById('customMinutes').value;
            if (!customMinutes || customMinutes < 1 || customMinutes > 1440) {
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 1440 –º–∏–Ω—É—Ç');
                return;
            }
            
            selectedExpiresIn = 'custom';
            respondToRequest(selectedRequestId, 'approved', customMinutes);
            hideTimeSelection();
        }

        // –û—Ç–º–µ–Ω–∞ –≤—ã–±–æ—Ä–∞ –≤—Ä–µ–º–µ–Ω–∏
        function cancelTimeSelection() {
            hideTimeSelection();
        }

        // –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –∑–∞–ø—Ä–æ—Å
async function respondToRequest(requestId, response, customMinutes = null) {
    let confirmationMessage = '';
    
    if (response === 'approved') {
        confirmationMessage = `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ–¥–æ–±—Ä–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å?`;
    } else {
        confirmationMessage = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å?';
    }
    
    if (!confirm(confirmationMessage)) return;
    
    try {
        const data = {
            request_id: requestId,
            response: response
        };
        
        if (response === 'approved' && selectedExpiresIn) {
            data.expires_in = selectedExpiresIn;
            if (selectedExpiresIn === 'custom' && customMinutes) {
                data.custom_minutes = customMinutes;
            }
        }
        
        const result = await fetch('/respond_chat_request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        const responseData = await result.json();
        
        if (responseData.success) {
            alert(responseData.message);
            showRequests();  // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: showChatRequests() -> showRequests()
            loadAvailableChats();
        } else {
            alert('–û—à–∏–±–∫–∞: ' + responseData.error);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –∑–∞–ø—Ä–æ—Å:', error);
        alert('–û—à–∏–±–∫–∞: ' + error.message);
    }
}

// –£–¥–∞–ª–∏—Ç—å –∑–∞–ø—Ä–æ—Å –∞–¥–º–∏–Ω–æ–º
async function deleteAdminRequest(requestId) {
    if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å?')) return;
    
    try {
        const result = await fetch('/respond_chat_request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                request_id: requestId,
                response: 'deleted'
            })
        });
        
        const data = await result.json();
        
        if (data.success) {
            alert('‚úÖ –ó–∞–ø—Ä–æ—Å —É–¥–∞–ª—ë–Ω!');
            showRequests();  // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ: showChatRequests() -> showRequests()
        } else {
            alert('–û—à–∏–±–∫–∞: ' + data.error);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–∞:', error);
        alert('–û—à–∏–±–∫–∞: ' + error.message);
    }
}

        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —á–∞—Ç
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            const chatMessages = document.getElementById('chatMessages');
            const sendBtn = document.getElementById('sendBtn');
            
            sendBtn.disabled = true;
            sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';
            
            const tempId = 'temp_' + Date.now();
            const tempMessage = document.createElement('div');
            tempMessage.id = tempId;
            tempMessage.className = 'message own';
            tempMessage.innerHTML = `
                <div class="message-sender">
                    –í—ã
                    <span class="sender-role">${currentRole}</span>
                    <span class="message-status status-sent">
                        <i class="fas fa-check"></i>
                    </span>
                </div>
                <div class="message-text">${escapeHtml(message)}</div>
                <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
            `;
            
            chatMessages.prepend(tempMessage);
            input.value = '';
            chatMessages.scrollTop = 0;
            
            let url, data;
            
            if (currentChatType === 'global') {
                url = '/send_chat_message';
                data = { message: message };
            } else {
                url = '/send_private_message';
                data = {
                    receiver_id: currentPrivateChatId,
                    message: message
                };
            }
            
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    tempMessage.querySelector('.message-status').className = 'message-status status-delivered';
                    tempMessage.querySelector('.message-status i').className = 'fas fa-check-double';
                    
                    setTimeout(() => {
                        loadChatMessages();
                    }, 1000);
                } else {
                    tempMessage.classList.add('error');
                    const errorDiv = document.createElement('div');
                    errorDiv.className = 'text-danger small mt-1';
                    errorDiv.textContent = '–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ' + (result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                    tempMessage.appendChild(errorDiv);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏:', error);
                tempMessage.classList.add('error');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'text-danger small mt-1';
                errorDiv.textContent = '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ' + error.message;
                tempMessage.appendChild(errorDiv);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = '–û—Ç–ø—Ä–∞–≤–∏—Ç—å';
            }
        }

        // –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è —á–∞—Ç–∞
        async function loadChatMessages() {
            let url;
            
            if (currentChatType === 'global') {
                url = '/get_chat_messages';
            } else {
                if (!currentPrivateChatId) return;
                url = `/get_private_messages/${currentPrivateChatId}`;
            }
            
            const chatMessages = document.getElementById('chatMessages');
            
            chatMessages.innerHTML = `
                <div class="chat-loading">
                    <div class="spinner-border" role="status" style="color: var(--accent-green);">
                        <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                    </div>
                    <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</p>
                </div>
            `;
            
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const messages = await response.json();
                
                chatMessages.innerHTML = '';
                
                if (messages.error) {
                    chatMessages.innerHTML = `
                        <div class="chat-empty">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞</p>
                            <small>${messages.error}</small>
                        </div>
                    `;
                    return;
                }
                
                if (messages.length === 0) {
                    chatMessages.innerHTML = `
                        <div class="chat-empty">
                            <i class="far fa-comments"></i>
                            <p>–°–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç</p>
                            <small>–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–≤—ã–º</small>
                        </div>
                    `;
                    return;
                }
                
                messages.forEach(msg => {
                    let isOwn = false;
                    let senderName = '';
                    let senderRole = '';
                    
                    if (currentChatType === 'global') {
                        isOwn = msg.user_id == currentUserId;
                        senderName = msg.full_name || msg.username;
                        senderRole = msg.role || 'user';
                    } else {
                        isOwn = msg.sender_id == currentUserId;
                        senderName = msg.sender_full_name || msg.sender_username;
                        senderRole = msg.sender_role || 'user';
                    }
                    
                    const messageDiv = document.createElement('div');
                    messageDiv.className = `message ${isOwn ? 'own' : 'other'}`;
                    
                    messageDiv.innerHTML = `
                        <div class="message-sender">
                            ${isOwn ? '–í—ã' : escapeHtml(senderName)}
                            <span class="sender-role">${senderRole}</span>
                            ${isOwn ? '<span class="message-status status-read"><i class="fas fa-check-double"></i></span>' : ''}
                        </div>
                        <div class="message-text">${escapeHtml(msg.message)}</div>
                        <div class="message-time">
                            ${new Date(msg.created_at).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}
                        </div>
                    `;
                    
                    chatMessages.appendChild(messageDiv);
                });
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
                chatMessages.innerHTML = `
                    <div class="chat-empty">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —á–∞—Ç–∞</p>
                        <small>${error.message}</small>
                    </div>
                `;
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function showStatus(type, message) {
            const statusDiv = document.getElementById('permissionStatus');
            statusDiv.className = `permission-status ${type}`;
            statusDiv.innerHTML = message;
            statusDiv.style.display = 'block';
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–ª–∞–≤–∏—à–∏ Enter –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatMessage();
            }
        }

        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        async function checkNewMessages() {
            if (!chatOpen && currentUserId) {
                try {
                    const response = await fetch('/get_unread_count');
                    if (!response.ok) return;
                    
                    const data = await response.json();
                    
                    if (data.total > 0) {
                        messageCount = data.total;
                        updateChatIconNotification(messageCount);
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
                        loadAvailableChats();
                    } else {
                        updateChatIconNotification(0);
                    }
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
                }
            }
        }
        
        // –û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç
        async function clearChat() {
            let confirmationMessage = '';
            let data = {};
            
            if (currentChatType === 'global') {
                if (currentRole !== 'admin' && currentRole !== 'manager') {
                    alert('–¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∏–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä –º–æ–∂–µ—Ç –æ—á–∏—Å—Ç–∏—Ç—å –æ–±—â–∏–π —á–∞—Ç');
                    return;
                }
                confirmationMessage = '–û—á–∏—Å—Ç–∏—Ç—å –æ–±—â–∏–π —á–∞—Ç? –í—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.';
                data = { chat_type: 'global' };
            } else if (currentChatType === 'private' && currentPrivateChatId) {
                confirmationMessage = '–û—á–∏—Å—Ç–∏—Ç—å –ª–∏—á–Ω—É—é –ø–µ—Ä–µ–ø–∏—Å–∫—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.';
                data = { 
                    chat_type: 'private',
                    other_user_id: currentPrivateChatId 
                };
            } else {
                return;
            }
            
            if (!confirm(confirmationMessage)) return;
            
            try {
                const response = await fetch('/clear_chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    loadChatMessages();
                    loadAvailableChats();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + result.error);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —á–∞—Ç–∞:', error);
                alert('–û—à–∏–±–∫–∞ –æ—á–∏—Å—Ç–∫–∏ —á–∞—Ç–∞: ' + error.message);
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        if (currentUserId) {
            loadAvailableChats();
            
            setInterval(() => {
                if (!chatOpen && currentUserId) {
                    checkNewMessages();
                }
            }, 10000);
            
            setTimeout(() => {
                checkNewMessages();
            }, 1000);
            
            document.addEventListener('click', function(event) {
                const chatWindow = document.getElementById('chatWindow');
                const chatIcon = document.querySelector('.chat-icon');
                
                if (chatOpen && 
                    !chatWindow.contains(event.target) && 
                    !chatIcon.contains(event.target)) {
                    toggleChat();
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            if (currentRole === 'admin') {
                setInterval(updateRequestsCount, 30000);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–∞
        function highlightSearchResult(result) {
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞
            document.getElementById('searchResults').style.display = 'none';
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–∏—Å–∫–µ
            sessionStorage.setItem('searchResult', JSON.stringify(result));
            sessionStorage.setItem('searchQuery', document.getElementById('globalSearch').value);
            
            // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å —ç–ª–µ–º–µ–Ω—Ç–æ–º
            window.location.href = result.highlight_url;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        function applySearchHighlight() {
            // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
            const urlParams = new URLSearchParams(window.location.search);
            const highlightId = urlParams.get('highlight');
            
            if (!highlightId) return; // –ï—Å–ª–∏ –Ω–µ—Ç highlight - –≤—ã—Ö–æ–¥–∏–º
            
            // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–∏—Å–∫–∞
            const searchResult = sessionStorage.getItem('searchResult');
            const searchQuery = sessionStorage.getItem('searchQuery');
            
            if (!searchResult || !searchQuery) return; // –ï—Å–ª–∏ –Ω–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            
            const result = JSON.parse(searchResult);
            
            // –ñ–¥–µ–º 0.5 —Å–µ–∫—É–Ω–¥—ã, —á—Ç–æ–±—ã —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å
            setTimeout(() => {
                // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
                let element = null;
                
                // –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –∏—â–µ–º —ç–ª–µ–º–µ–Ω—Ç (—Ç–µ–ø–µ—Ä—å –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫)
                if (result.type === 'animal') {
                    element = document.querySelector(`div[data-animal-id="${highlightId}"]`);
                } else if (result.type === 'task') {
                    element = document.querySelector(`div[data-task-id="${highlightId}"]`);
                } else if (result.type === 'field') {
                    element = document.querySelector(`div[data-field-id="${highlightId}"]`);
                } else if (result.type === 'user') {
                    element = document.querySelector(`div[data-user-id="${highlightId}"]`);
                }
                
                // –ï—Å–ª–∏ —ç–ª–µ–º–µ–Ω—Ç –Ω–∞–π–¥–µ–Ω, –≤—ã–¥–µ–ª—è–µ–º –µ–≥–æ
                if (element) {
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –≤—ã–¥–µ–ª–µ–Ω–∏—è
                    element.classList.add('search-highlight');
                    
                    // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –∫ —ç–ª–µ–º–µ–Ω—Ç—É
                    element.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center'
                    });
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    createHighlightNotification(result, searchQuery);
                    
                    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                    setTimeout(() => {
                        element.classList.remove('search-highlight');
                    }, 5000);
                    
                    // –û—á–∏—â–∞–µ–º sessionStorage
                    sessionStorage.removeItem('searchResult');
                    sessionStorage.removeItem('searchQuery');
                }
            }, 500);
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–∞–π–¥–µ–Ω–Ω–æ–º —ç–ª–µ–º–µ–Ω—Ç–µ
        function createHighlightNotification(result, query) {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ –µ—Å—Ç—å
            const oldNotification = document.querySelector('.search-highlight-notification');
            if (oldNotification) {
                oldNotification.remove();
            }
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            const notification = document.createElement('div');
            notification.className = 'search-highlight-notification alert alert-info alert-dismissible fade show';
            
            let icon = '';
            let details = '';
            
            // –í –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤—ã–±–∏—Ä–∞–µ–º –∏–∫–æ–Ω–∫—É
            switch(result.type) {
                case 'animal':
                    icon = 'üêÑ';
                    details = `<strong>${result.name}</strong><br>
                              <small>${result.details}</small><br>
                              <small class="text-muted">–°—Ç–∞—Ç—É—Å: ${result.status}</small>`;
                    break;
                case 'task':
                    icon = 'üìã';
                    details = `<strong>${result.name}</strong><br>
                              <small>${result.details}</small><br>
                              <small class="text-muted">–î–µ–¥–ª–∞–π–Ω: ${result.due_date || '–ù–µ —É–∫–∞–∑–∞–Ω'}</small>`;
                    break;
                case 'field':
                    icon = 'üåæ';
                    details = `<strong>${result.name}</strong><br>
                              <small>${result.details}</small>`;
                    break;
                case 'user':
                    icon = 'üë§';
                    details = `<strong>${result.name}</strong><br>
                              <small>${result.details}</small>`;
                    break;
            }
            
            notification.innerHTML = `
                <div class="d-flex align-items-start">
                    <div class="me-3 fs-4">${icon}</div>
                    <div class="flex-grow-1">
                        <h6 class="alert-heading mb-1">–ù–∞–π–¥–µ–Ω ${result.type_name}</h6>
                        <div class="mb-2">${details}</div>
                        <small class="text-muted">
                            <i class="fas fa-search me-1"></i>
                            –ü–æ –∑–∞–ø—Ä–æ—Å—É: "${query}"
                        </small>
                        <button type="button" class="btn btn-sm btn-outline-success mt-2" onclick="closeHighlightNotification()">
                            <i class="fas fa-times me-1"></i> –ó–∞–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                    <button type="button" class="btn-close" onclick="closeHighlightNotification()"></button>
                </div>
                <div class="progress mt-2" style="height: 3px;">
                    <div class="progress-bar bg-success" role="progressbar" style="width: 100%;" 
                         id="highlightProgress"></div>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞ (5 —Å–µ–∫—É–Ω–¥)
            const progressBar = document.getElementById('highlightProgress');
            let width = 100;
            const interval = setInterval(() => {
                if (width <= 0) {
                    clearInterval(interval);
                    notification.remove();
                } else {
                    width -= 0.2;
                    progressBar.style.width = width + '%';
                }
            }, 100);
        }

        // –ó–∞–∫—Ä—ã—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function closeHighlightNotification() {
            const notification = document.querySelector('.search-highlight-notification');
            if (notification) {
                notification.remove();
            }
        }
    </script>
</body>
</html>